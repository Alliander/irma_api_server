[![Build Status](https://travis-ci.org/credentials/irma_api_server.svg?branch=master)](https://travis-ci.org/credentials/irma_api_server)

# IRMA API server

This is a server that sits between IRMA tokens such as the [card emulator app](https://github.com/credentials/irma_android_cardemu) on the one hand, and service or identity providers on the other hand. It handles all IRMA-specific cryptographic details of issuing credentials and verifying disclosure proofs on behalf of the service or identity provider.

The API that this server offers is described [here](https://credentials.github.io/proposals/irma-without-apdus). We offer a javascript library, [irma.js](https://github.com/credentials/irma_js), that you can use in your webpages to easily issue and verify credentials.

See below to run or build the server yourself. Alternatively, you can use our demo API server, which is setup to be very permissive (but only in the demo domain). It is hosted at `https://demo.irmacard.org/tomcat/irma_api_server/`, you can find its signing key [here](https://demo.irmacard.org/v2/data/pk.pem).

# Experimental

This project is quite new, so do not be surprised by sudden changes in the API.

# Running and building the server

The gradle build file should take care the dependencies. To run the server in development mode simply call:

    gradle appRun

Alternatively, you can build the server, resulting in a standalone package that depends only on Java, as follows:

    gradle buildProduct

The resulting package will then be stored in `build/output/irma_api_server` and can be started with `start.sh`.

# Configuring the server
Currently, the server expects all configuration files in a single directory. The location of this server can be configured by setting a environment variable called `IRMA_API_CONF`, for example,

    IRMA_API_CONF=/etc/irma_api_server gradle appRun

or

    IRMA_API_CONF=/etc/irma_api_server ./start.sh

depending if you are running a build or not. If this variable is left empty, then the server will try the following locations:
 1. `src/main/resources`
 2. `/etc/irma_api_server`
 3. `C:\irma_api_server`
 4. `~/irma_api_server`

The main configuration file is a json file called `config.json`. In `src/main/resources` a sample configuration file called `config.SAMPLE.json` is included, showing all options, their defaults, and what they mean.

## irma_configuration

All credential descriptions, issuer public keys and possibly private keys are expected in a subdirectory called `irma_configuration` within the configuration directory, organized as in our [irma_configuration](https://github.com/credentials/irma_configuration/tree/combined) repository (be sure to use the `combined` branch).

## Ports

You can change the ports on which a build of the server listens as follows:

    ./start.sh --runnerArg="httpPort=8080" --runnerArg="httpsPort=8443"

If you want to change the ports when using `gradle appRun` to start the server, you'll have to modify `build.gradle`.

## JWT keys

The server uses [JSON web tokens (JWT's)](https://en.wikipedia.org/wiki/JSON_Web_Token) for verifying the authenticity of incoming requests and for signing its output, in the case of verification. Before you can use the server, you need to set up some of the public and private keys for this. For this we have included a bash script `keygen.sh`, that uses the `openssl` command line tool. All keys must be in the DER format. In more detail:

 * `sk.der` in the configuration path is used to sign the final message to the service provider in a verification session. This can easily be generated by executing `utils/keygen.sh` (This will also generate the corresponding public key `pk.der`, which is not needed by the server, except when running unit tests.)
 * Identity and service providers must send their requests to the server in the form of JSON web tokens. Thus the server needs to know the public keys of all authorized service and/or identity providers. These are also stored in `issuers/` and `verifiers/` in the configuration path; see the configuration file for details.

Neither `utils/keygen.sh` nor `utils/preparetest.sh` will overwrite existing files.

# Testing

You can run the included unit tests by running `gradle test`; in this case `src/test/resources` will always be used as the configuration directory (which comes with its own configuration files for this purpose, as well as `irma_configuration` as a git submodule. Be sure to run `git submodule init && git submodule update`!).

A test service provider and identity provider, written in node.js, is included; see `utils/testsp.js` and `utils/testip.js` respectively. If you haven't done so already, you should install the dependencies (assuming you already have node.js installed):

    npm install qrcode-terminal request jsonwebtoken fs

Furthermore, you should run the `utils/preparetestjs.sh` script to prepare testing keys (which will be placed in `src/main/resources`), and make sure that you enable these test keys in your `config.json` in `src/main/resources`, for example. Using `config.sample-demo.json` as the configuration file should do the trick.

After this you can run it using:

    node utils/testsp.js http://<SERVER>:8081 [configuration_dir]

where `<SERVER>` refers to the IP address or hostname of your running `irma_api_server`, and where the optional second argument specifies the configuration directory in which the script is to find the JWT keys (if absent, `src/main/resources` is assumed). Make sure you use an address that the IRMA app can also reach (we usually use a local ip address for testing).

For more sophisticated examples, see [irma_js](https://github.com/credentials/irma_js).

# Testing with cURL

To make a GET request on a resource:

    curl -i -H "Accept: application/json" http://localhost:8080/irma_api_server/api/hello/json

To make a POST request on a resource:

    curl -X POST -H "Content-Type: application/json" -d '{"a": 5.0,"b": -22.0}' http://localhost:8080/irma_api_server/api/hello/json
