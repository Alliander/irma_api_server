# IRMA API server

This is a server that sits between IRMA tokens such as the [card emulator app](https://github.com/credentials/irma_android_cardemu) on the one hand, and service or identity providers on the other hand. It handles all IRMA-specific cryptographic details of issuing credentials and verifying disclosure proofs on behalf of the service or identity provider.

The API that this server offers is described [here](https://credentials.github.io/proposals/irma-without-apdus). We offer a javascript library, [irma.js](https://github.com/credentials/irma_js), that you can use in your webpages to easily issue and verify credentials.

See below to run the server yourself. Alternatively, you can use our demo API server, which is setup to be very permissive (but only in the demo domain). It is hosted at `https://demo.irmacard.org/tomcat/irma_api_server/`, you can find its signing key [here](https://demo.irmacard.org/v2/data/pk.pem).

# Experimental

This project is quite new, so do not be surprised by sudden changes in the API.

# Running the server

The gradle build file should take care the dependencies. To run the server in development mode simply call:

    gradle appRun

## JWT keys

The server uses [JSON web tokens (JWT's)](https://en.wikipedia.org/wiki/JSON_Web_Token) for verifying the authenticity of incoming requests and for signing its output, in the case of verification. Before you can use the server, you need to set up some of the public and private keys for this. For this we have included a bash script `keygen.sh`, that uses the `openssl` command line tool. All keys must be in the DER format. In more detail:

 * `sk.der` is used to sign the final message to the service provider in a verification session. This can easily be generated by executing `../../../utils/keygen.sh` in `src/main/resources`. (This will also generate the corresponding public key `pk.der`, which is not needed by the server, except when running unit tests.)
 * Identity and service providers must send their requests to the server in the form of JSON web tokens. Thus the server needs to know the public keys of all authorized service and/or identity providers. These are also stored in `src/main/resources/issuers` and `src/main/resources/verifiers`; see the configuration file for details.
 * When running the unit tests, the server must have keys to sign and verify simulated incoming issuing and verification requests. You can easily generate all of these at once using the `utils/preparetest.sh` bash script. This generates one private key called `test-sk.der`, and puts the corresponding public key in `verifiers/testsp.der` and `issuers/testip.der` (this time in `src/test/resources`).

Neither `utils/keygen.sh` nor `utils/preparetest.sh` will overwrite existing files.

## Configuring the server
The server can be configured using a json file at `src/main/resources/config.json`. In the same directory a sample configuration file called `config.SAMPLE.json` is included, showing all options, their defaults, and what they mean.

## irma_configuration

Download or link the `irma_configuration` project to `src/main/resources/`. If both projects are in the same directory the following should work:

    ln -s ../../../../irma_configuration src/main/resources/

Alternatively, you can just run `preparetest.sh`. See the credentials/irma_configuration project for the specifics. Since we already transitioned the irma_api_server to the new configuration format you have to use the `combined` branch of `irma_configuration`.

# Testing

A test service provider and identity provider, written in node.js, is included; see `testsp.js` and `testip.js` respectively. Assuming you have node.js installed, you can run it by `node testsp.js url-to-server` (perhaps after running `npm install qrcode-terminal request jsonwebtoken fs`).

For more sophisticated examples, see [irma_js](https://github.com/credentials/irma_js).

# Testing with cURL

To make a GET request on a resource:

    curl -i -H "Accept: application/json" http://localhost:8080/irma_api_server/api/hello/json

To make a POST request on a resource:

    curl -X POST -H "Content-Type: application/json" -d '{"a": 5.0,"b": -22.0}' http://localhost:8080/irma_api_server/api/hello/json
